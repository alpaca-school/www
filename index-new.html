<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>アルパカすく〜る｜体験フロア 🦙</title>
  <link rel="icon"
    href="https://lh6.googleusercontent.com/HUVxVFqoa_HrqwbO5sJ2JLzW8zY1A2HWxKXhjxrLsOG__vg47Yqrj85Vc1kSb9FxaFmxYM2tp2IBQ5r8mq0dh36txvYtg3hFfBowEr6rJiBaoG5bSmRmqYHmOA=w16383">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap');

    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
    }

    .text-fluid-4xl {
      font-size: clamp(2rem, 6vw, 3rem);
    }

    .text-fluid-xl {
      font-size: clamp(1.1rem, 3vw, 1.5rem);
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      scrollbar-width: none;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /* ========= 設定 ========= */
    // Googleスプレッドシートのデータを読み込むためのURL
    // CORSエラーを回避するため、別のプロキシサービス(corsproxy.io)を経由させます
    // ※ 本来は「ファイル」→「共有」→「Webに公開」で発行されたURLを使うのが最も確実です
    const SHEET_ID = "1YXtuEzZHrV236tzNj7DfvdweXxAGZZNP8OVGJbujrrg";
    const TARGET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
    const SHEET_CSV_URL = "https://corsproxy.io/?" + encodeURIComponent(TARGET_URL);



    /* ========= フロア意味づけ（体験ベース） ========= */
    const floorMeta = {
      歴史: "過去を知り、今を理解する",
      文化: "手仕事と物語に触れる",
      自然: "生きている環境を感じる",
      平和: "社会と自分の関係を考える",
      生活: "暮らしの中で生きる力を育てる",
      仕事: "社会と関わる準備をする"
    };

    const floors = ["歴史", "文化", "自然", "平和", "生活", "仕事"];

    /* ========= 初期の静的データ ========= */
    const initialFloorData = {
      歴史: {
        title: "歴史", color: "bg-pink-100 border-pink-300", headerColor: "bg-pink-200",
        sections: [
          {
            id: "K4",
            title: "🍠 サツマイモ物語 🍠",
            description: "原産地から日本へ ― 食べ物の世界旅行",
            location: "特別展示",
            actionType: "modal",
            modalUrl: "./rekishi/sweet_potato_history.html"
          },
          {
            id: "H-oldhouse",
            title: "沖縄の古い家探検❗️",
            description: "沖縄の伝統的な家屋の工夫を見てみよう",
            location: "郷土",
            videoId: "QpI0t9jXbwU"
          },
          {
            id: "rekishi-food",
            title: "食糧確保と感謝の心",
            description: "へいわ教育プログラム：芋中心の自給自足と創意工夫",
            location: "平和学習",
            actionType: "modal",
            modalUrl: "./rekishi/food.html"
          },
          {
            id: "rekishi-warburg",
            title: "オットー・ワールブルク",
            description: "生命のエネルギーを解き明かした巨人",
            location: "科学史",
            actionType: "modal",
            modalUrl: "./rekishi/warburg.html"
          },
          {
            id: "rekishi-warburg-study",
            title: "仮説実験授業：ワールブルク",
            description: "オットー・ワールブルクの発見を追体験する",
            location: "科学史",
            actionType: "modal",
            modalUrl: "./rekishi/warburg_study_material.html"
          },
          {
            id: "H-imo",
            title: "お芋のチカラ",
            description: "飢饉から人々を救ったお芋の歴史と効果",
            location: "歴史",
            isComingSoon: true
          }
        ]
      },
      文化: {
        title: "文化", color: "bg-green-100 border-green-300", headerColor: "bg-green-200",
        sections: [
          {
            id: "S1",
            title: "読谷やちむんの里 オンライン陶芸鑑賞会",
            description: "自宅でゆっくり、器と手仕事の物語に触れる",
            location: "4C",
            actionType: "modal",
            modalUrl: "./bunka/yachimun.html"
          },
          {
            id: "C-shisa",
            title: "シーサーを作ろう❗️",
            description: "守り神シーサーを粘土で作ってみよう",
            location: "工房",
            videoId: "Nb7Nfb0embU"
          },
          {
            id: "C-sanshin",
            title: "楽器を演奏しよう❗️",
            description: "沖縄の伝統楽器「三線」の音色",
            location: "舞台",
            videoId: "Zm8X3FACbF0"
          },
          {
            id: "C-obon",
            title: "1分でわかる❗️沖縄のお盆❗️",
            description: "ご先祖さまをお迎えする大切な行事",
            location: "行事",
            videoId: "PZ4YPyx3B9I"
          },
          {
            id: "C-mimigusuri",
            title: "歌や耳ぐすり",
            description: "工工四と三線でみんなを楽しませよう",
            location: "舞台",
            isComingSoon: true
          }
        ]
      },
      自然: {
        title: "自然", color: "bg-orange-100 border-orange-300", headerColor: "bg-orange-200",
        sections: [
        ]
      },
      平和: {
        title: "平和", color: "bg-blue-100 border-blue-300", headerColor: "bg-blue-200",
        sections: [

        ]
      },
      生活: {
        title: "生活",
        color: "bg-yellow-100 border-yellow-300",
        headerColor: "bg-yellow-200",
        sections: [
          {
            id: "L-money-0",
            title: "クレジットカードとの付き合い方",
            description: "お金と安全につきあうための基礎知識",
            location: "お金",
            learningContent: {
              title: "クレジットカードとの付き合い方",
              html: `
                <h3>🦙 アルパカ先生のクレカ講座</h3>
                <strong>⚠️ リボ払いは絶対NG</strong>
                <ul>
                  <li>一括・2回払いを基本に</li>
                  <li>利用額は収入の1/3以内</li>
                  <li>「後払い」であることを理解する</li>
                </ul>
              `
            }
          },
          {
            id: "L-money-1",
            title: "詐欺から身を守ろう！",
            description: "悪徳商法・詐欺の典型パターン",
            location: "お金",
            learningContent: {
              title: "悪徳商法の見分け方",
              html: `
                <ul>
                  <li>「必ず儲かる」は危険</li>
                  <li>友人経由の勧誘に注意</li>
                  <li>高額な初期費用を要求される</li>
                </ul>
                <p>困ったら <strong>消費生活センター（188）</strong></p>
              `
            }
          },
          {
            id: "L-money-3",
            title: "家庭学習が成績になる！",
            description: "家庭・フリースクールの学びが評価される仕組み",
            location: "特別展示",
            actionType: "modal",
            modalUrl: "https://alpaca-school.okinawa/1722582416_d3e0b7a5d8a3c6b1e4b5a0d8c7b6a5d4.html"
          },
          {
            id: "L-money-4",
            title: "COCOLOプランとは？",
            description: "誰一人取り残されない学びの設計",
            location: "特別展示",
            actionType: "modal",
            modalUrl: "https://alpaca-school.okinawa/250802cocolo.html"
          },
          {
            id: "L-money-5",
            title: "楽しく英語学習♪",
            description: "英語の基礎を体験するオンライン教材",
            location: "特別展示",
            actionType: "modal",
            modalUrl: "https://alpaca-school.okinawa/training/english-training.html"
          },
          {
            id: "L-bug",
            title: "虫除けスプレーを作ろう",
            description: "月桃の葉っぱで自然な虫除け",
            location: "生活の知恵",
            isComingSoon: true
          },
          {
            id: "L-snack",
            title: "おやつづくり",
            description: "ちんびんとポーポーを作ろう",
            location: "キッチン",
            isComingSoon: true
          },
          {
            id: "L-cooking",
            title: "沖縄料理を作ってみよう",
            description: "苦味を楽しむゴーヤーチャンプルー",
            location: "キッチン",
            isComingSoon: true
          },
          {
            id: "L-curry",
            title: "カレーの学校",
            description: "スパイスから作る沖縄アーユルヴェーダ",
            location: "キッチン",
            isComingSoon: true
          },
          {
            id: "L-miso",
            title: "味噌作り",
            description: "腸活に！大豆やおからで手作り味噌",
            location: "キッチン",
            isComingSoon: true
          },

        ]
      },
      仕事: {
        title: "仕事", color: "bg-cyan-100 border-cyan-300", headerColor: "bg-cyan-200",
        sections: [
        ]
      }
    };

    /* ========= Components ========= */

    const Hero = () => (
      <section className="bg-gradient-to-b from-sky-100 to-gray-50">
        <div className="max-w-4xl mx-auto p-8 text-center">
          <h1 className="text-fluid-4xl font-extrabold mb-4">アルパカすく〜る 🦙</h1>
          <p className="text-fluid-xl text-gray-700 leading-relaxed">
            「やってみたい」を、<br />勉強・生活・仕事・社会につながる形で試せる場所。
          </p>
          <p className="mt-4 text-sm text-gray-600 leading-relaxed">
            学ぶ・つくる・つながる。<br />
            子どもから大人まで、沖縄の雑学を学ぶオンライン学び舎。
          </p>
        </div>
      </section>
    );

    const Header = ({ currentFloor, setCurrentFloor, meta, data }) => (
      <header className={`${data.headerColor} sticky top-0 z-10 shadow`}>
        <div className="max-w-4xl mx-auto p-4">
          <h2 className="text-xl font-extrabold">{currentFloor}</h2>
          <p className="text-sm text-gray-700">{meta}</p>
          <div className="flex gap-2 overflow-x-auto no-scrollbar mt-3">
            {floors.map(f => (
              <button key={f}
                onClick={() => setCurrentFloor(f)}
                className={`px-4 py-2 rounded-lg font-bold hover:bg-white transition ${f === currentFloor ? "bg-white" : "bg-white/50"}`}>
                {f}
              </button>
            ))}
          </div>
        </div>
      </header>
    );

    const FloorContent = ({ data, onVideoClick, onModalClick }) => (
      <main className="max-w-4xl mx-auto p-6 grid md:grid-cols-2 gap-4">
        {data.sections.map(s => (
          <div key={s.id} className={`${data.color} border-2 rounded-xl p-6 shadow`}>
            <h3 className="font-bold text-lg mb-2">{s.title}</h3>
            <p className="text-sm text-gray-700 mb-4">{s.description}</p>
            {s.videoId && (
              <button onClick={() => onVideoClick(s.videoId)}
                className="bg-red-500 text-white px-3 py-2 rounded font-bold hover:bg-red-600 transition">
                動画を見る
              </button>
            )}
            {(s.actionType === "modal" || s.learningContent) && (
              <button onClick={() => onModalClick(s)}
                className="bg-purple-500 text-white px-3 py-2 rounded font-bold ml-2 hover:bg-purple-600 transition">
                学ぶ
              </button>
            )}
            {s.isComingSoon && (
              <button disabled
                className="bg-gray-300 text-gray-500 px-3 py-2 rounded font-bold ml-2 cursor-not-allowed">
                Coming Soon
              </button>
            )}
          </div>
        ))}
      </main>
    );

    const Footer = () => (
      <>
        <section className="max-w-4xl mx-auto p-6">
          <div className="bg-white border-2 border-dashed rounded-xl p-6 text-center">
            <h3 className="font-bold text-lg mb-2">学んだことを、次の一歩へ</h3>
            <p className="text-sm text-gray-600 mb-2">
              体験したことは、表現を通して社会とつながっていきます。
            </p>
            <a href="https://furima.ryukyu-tane.com"
              target="_blank"
              rel="noopener noreferrer"
              className="bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-emerald-600 transition inline-block">
              文芸フリマで表現してみる
            </a>
          </div>
        </section >

        <section className="max-w-4xl mx-auto p-6">
          <div className="bg-white border-2 border-dashed border-gray-200 rounded-xl p-8 text-center">
            <p className="mb-4 text-gray-700">
              学びの中で使った教材や記録をまとめています。
            </p>
            <a href="https://universe.tea-under.club/"
              className="inline-block px-6 py-2 bg-blue-50 text-blue-900 rounded-full font-bold hover:bg-blue-100 transition">
              てぃあんだぁクラブ universe
            </a>
          </div>
        </section>

        <footer className="bg-gray-800 text-white p-6 text-sm">
          <div className="max-w-4xl mx-auto">
            <p>
              仕事は、誰かとのご縁。<br />
              アルパカすく〜るは、その入口をつくります。
              <br />
              このコンテンツは、ご自宅から快適に学習できるよう設計されています。車椅子をご利用の方、高齢の方、外出が難しい方など、すべての方が楽しめるよう善処します。
            </p>
            <a
              href="./concept.html"
              className="inline-block mt-2 underline hover:text-emerald-300"
            >
              ▶ この学びの設計思想を読む
            </a>
          </div>
        </footer>
      </>
    );

    const VideoModal = ({ videoId, onClose }) => (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={onClose}>
        <div className="relative w-full max-w-4xl">
          <button
            onClick={onClose}
            className="absolute -top-10 right-0 text-white hover:text-gray-300 text-sm font-bold"
            aria-label="閉じる">
            ✕ 閉じる (ESC)
          </button>
          <iframe
            key={videoId}
            src={`https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1`}
            title="YouTube video player"
            className="w-full aspect-video rounded-lg"
            onClick={(e) => e.stopPropagation()}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerPolicy="strict-origin-when-cross-origin"
            allowFullScreen
          />
        </div>
      </div>
    );

    const ContentModal = ({ content, onClose }) => (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={onClose}>
        <div className="relative w-full max-w-4xl h-5/6">
          <button
            onClick={onClose}
            className="absolute -top-10 right-0 text-white hover:text-gray-300 text-sm font-bold"
            aria-label="閉じる">
            ✕ 閉じる (ESC)
          </button>
          {content.modalUrl ? (
            <iframe
              src={content.modalUrl}
              className="w-full h-full rounded-lg bg-white"
              onClick={(e) => e.stopPropagation()}
            />
          ) : content.learningContent ? (
            <div
              className="w-full h-full rounded-lg bg-white p-8 overflow-y-auto"
              onClick={(e) => e.stopPropagation()}>
              <h3 className="text-2xl font-bold mb-4">{content.learningContent.title}</h3>
              <div dangerouslySetInnerHTML={{ __html: content.learningContent.html }} />
            </div>
          ) : null}
        </div>
      </div>
    );

    function App() {
      const [currentFloor, setCurrentFloor] = useState("歴史");
      const [videoUrl, setVideoUrl] = useState(null);
      const [modal, setModal] = useState(null);
      const [floorData, setFloorData] = useState(initialFloorData);
      const [fetchError, setFetchError] = useState(null);

      // Google Sheetからのデータ取得
      useEffect(() => {
        if (!SHEET_CSV_URL) return;

        // 注意: Google Sheetsの「Webに公開」したURL（.../pub?output=csv）でないと、
        // ブラウザのセキュリティ制限(CORS)により読み込みがブロックされることがよくあります。

        Papa.parse(SHEET_CSV_URL, {
          download: true,
          header: true,
          complete: function (results) {
            const fetchedData = results.data;
            console.log("Fetched Data:", fetchedData);

            if (fetchedData.length === 0) return;

            // 既存のデータをディープコピー
            const newFloorData = JSON.parse(JSON.stringify(initialFloorData));

            fetchedData.forEach(item => {
              if (!item.floor || !item.title) return;

              // データの整形
              const floorKey = item.floor;
              if (!newFloorData[floorKey]) return;

              const newSection = {
                id: item.id || Math.random().toString(36).substr(2, 9),
                title: item.title,
                description: item.description,
                location: item.location || "NEW",
                isComingSoon: item.coming_soon === "TRUE" || item.coming_soon === "true"
              };

              // typeに応じたプロパティ設定
              if (item.type === "video") {
                newSection.videoId = item.url;
              } else if (item.type === "modal") {
                newSection.actionType = "modal";
                newSection.modalUrl = item.url;
              }

              // セクションを追加
              newFloorData[floorKey].sections.push(newSection);
            });

            setFloorData(newFloorData);
            setFetchError(null);
            console.log("Updated floor data from Google Sheet");
          },
          error: function (err) {
            console.error("Error fetching CSV:", err);
            setFetchError("スプレッドシートの読み込みに失敗しました。URLが「Webに公開」のものか確認してください(CORSエラーの可能性)。");
          }
        });
      }, []);

      useEffect(() => { lucide.createIcons(); }, [currentFloor, videoUrl, modal, floorData]);

      useEffect(() => {
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            setVideoUrl(null);
            setModal(null);
          }
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
      }, []);

      const data = floorData[currentFloor];

      return (
        <div className="min-h-screen bg-gray-50">
          <Hero />

          {fetchError && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-4xl mx-auto mt-4" role="alert">
              <strong className="font-bold">設定エラー: </strong>
              <span className="block sm:inline">{fetchError}</span>
            </div>
          )}

          <Header
            currentFloor={currentFloor}
            setCurrentFloor={setCurrentFloor}
            meta={floorMeta[currentFloor]}
            data={data}
          />

          <FloorContent
            data={data}
            onVideoClick={setVideoUrl}
            onModalClick={setModal}
          />

          <Footer />

          {videoUrl && <VideoModal videoId={videoUrl} onClose={() => setVideoUrl(null)} />}
          {modal && <ContentModal content={modal} onClose={() => setModal(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>

</html>