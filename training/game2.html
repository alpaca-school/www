<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background-color: #f4f7f6; padding: 15px; color: #333; }
        .game-container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        h1 { color: #2c3e50; font-size: 24px; }
        button { font-size: 18px; margin: 8px; padding: 12px 20px; cursor: pointer; border-radius: 12px; border: none; background: #3498db; color: white; transition: 0.2s; width: 80%; }
        button:active { background: #2980b9; transform: scale(0.98); }
        select { font-size: 18px; padding: 8px; border-radius: 8px; margin: 5px; width: 60%; }
        .money-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .money-table th, .money-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        .profit { color: #e74c3c; font-weight: bold; }
        .happening { background: #fff3cd; padding: 10px; border-radius: 10px; border: 1px solid #ffeeba; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="game-container">
    <h1 id="game-title">ğŸ”¨ ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</h1>
    <div id="content">
        <p>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
        <input type="text" id="team-name" placeholder="ãƒãƒ¼ãƒ å" style="font-size: 18px; padding: 10px; width: 70%; border-radius: 8px; border: 1px solid #ccc;"><br><br>
        <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>
</div>

<script>
    let teamName = "";
    let turn = 1;
    let history = [];
    let prevMaterialWasCheap = false; // 1æœŸç›®ã«å®‰ã„ææ–™ã‚’ä½¿ã£ãŸã‹

    const stages = [
        { name: "1æœŸï¼šè¦‹ç¿’ã„æœŸé–“ ğŸ ", basePrice: 100000 },
        { name: "2æœŸï¼šæˆé•·æœŸé–“ ğŸ¡", basePrice: 300000 },
        { name: "3æœŸï¼šç¤¾é•·ã¸ã®é“ ğŸ°", basePrice: 600000 }
    ];

    function playSound() {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const osc = context.createOscillator();
        const gain = context.createGain();
        osc.connect(gain); gain.connect(context.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, context.currentTime);
        gain.gain.setValueAtTime(0.1, context.currentTime);
        osc.start(); osc.stop(context.currentTime + 0.1);
    }

    function startGame() {
        teamName = document.getElementById('team-name').value || "åç„¡ã—ã®è·äºº";
        document.getElementById('game-title').innerText = "ğŸ”¨ " + teamName + "ã®è·äººç´€è¡Œ";
        playSound();
        showSelection();
    }

    function showSelection() {
        let stage = stages[turn-1];
        let html = `<h3>${stage.name}</h3>`;
        
        html += `<p>ğŸ‘· äººæ•°: <select id="workers">
            <option value="1">1å</option><option value="2">2å</option>
            <option value="3">3å</option><option value="4">4å</option>
        </select></p>`;
        
        html += `<p>ğŸ’° çµ¦æ–™: <select id="salary">
            <option value="5000">å®‰ã„ (5,000å††)</option>
            <option value="15000" selected>ãµã¤ã† (15,000å††)</option>
            <option value="30000">é«˜ç´š (30,000å††)</option>
        </select></p>`;

        html += `<p>ğŸ§± ææ–™: <select id="material">
            <option value="0.5">å®‰ã„ææ–™ (ãƒªã‚¹ã‚¯æœ‰)</option>
            <option value="1.0" selected>æ¨™æº–ã®ææ–™</option>
            <option value="1.5">ã“ã ã‚ã‚Šã®ææ–™âœ¨</option>
        </select></p>`;

        if (turn === 2) {
            html += `<p>âœ¨ ã‚¤ãƒ™ãƒ³ãƒˆ: <select id="event">
                <option value="none">ãªã—</option>
                <option value="wedding">çµå©š (ãŠç¥ã„é‡‘ -5ä¸‡)</option>
                <option value="indep">ç‹¬ç«‹æº–å‚™ (å‹‰å¼·ä»£ -10ä¸‡)</option>
                <option value="study">å­¦ã³ç›´ã— (ã‚¹ã‚­ãƒ«UP -3ä¸‡)</option>
            </select></p>`;
        }

        html += `<button onclick="calculateTurn()">ã“ã®å†…å®¹ã§æ±ºç®—ï¼</button>`;
        document.getElementById('content').innerHTML = html;
    }

    function calculateTurn() {
        playSound();
        let stage = stages[turn-1];
        let workers = parseInt(document.getElementById('workers').value);
        let salaryPerPerson = parseInt(document.getElementById('salary').value);
        let matMultiplier = parseFloat(document.getElementById('material').value);
        
        // åŸºæœ¬å£²ä¸Š
        let sales = stage.basePrice * matMultiplier;
        let happeningMsg = "";
        let happeningLoss = 0;

        // ãƒãƒ—ãƒ‹ãƒ³ã‚°åˆ¤å®š (3æœŸç›®)
        if (turn === 3) {
            let rnd = Math.random();
            if (prevMaterialWasCheap) {
                happeningMsg = "âš ï¸ éå»ã®å®‰ã„ææ–™ã§æå®³è³ å„ŸãŒç™ºç”Ÿï¼";
                happeningLoss = 200000;
            } else if (rnd < 0.3) {
                happeningMsg = "âš ï¸ äº‹æ•…ãƒ»ç—…æ°—ã§ä½œæ¥­ãŒé…ã‚ŒãŸï¼";
                happeningLoss = 100000;
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆçµŒè²» (2æœŸç›®)
        let eventCost = 0;
        if (turn === 2) {
            let ev = document.getElementById('event').value;
            if (ev === "wedding") eventCost = 50000;
            if (ev === "indep") eventCost = 100000;
            if (ev === "study") { eventCost = 30000; sales += 50000; } // å­¦ã³ç›´ã—ã¯å£²ä¸ŠUP
        }

        // çµŒè²»è¨ˆç®—
        let laborCost = workers * salaryPerPerson;
        let matCost = stage.basePrice * 0.4 * matMultiplier;
        let totalCost = laborCost + matCost + eventCost + happeningLoss;
        let profit = sales - totalCost;

        // 1æœŸç›®ã®ææ–™ãƒã‚§ãƒƒã‚¯
        if (turn === 1 && matMultiplier < 1.0) prevMaterialWasCheap = true;

        history.push({ turn, sales, laborCost, matCost, eventCost, happeningLoss, profit });

        let html = happeningMsg ? `<div class="happening">${happeningMsg}</div>` : "";
        html += `<h3>${turn}æœŸã®çµæœ</h3>`;
        html += `<p>ğŸ’° å£²ä¸Š: ${sales.toLocaleString()}å††</p>`;
        html += `<p>ğŸ’¸ çµŒè²»åˆè¨ˆ: ${totalCost.toLocaleString()}å††</p>`;
        html += `<p class="profit">ğŸ“ˆ åˆ©ç›Š: ${profit.toLocaleString()}å††</p>`;
        html += `<button onclick="nextStep()">æ¬¡ã¸</button>`;
        document.getElementById('content').innerHTML = html;
    }

    function nextStep() {
        turn++;
        if (turn > 3) {
            showFinalResult();
        } else {
            showSelection();
        }
    }

    function showFinalResult() {
        let total = history.reduce((sum, h) => sum + h.profit, 0);
        let html = `<h2>å®Œï¼æ©è¿”ã—ã®çµæœ«</h2>`;
        html += `<p>3æœŸåˆè¨ˆã®åˆ©ç›Š: <span class="profit">${total.toLocaleString()}å††</span></p>`;
        
        html += `<table class="money-table">
            <tr><th>æœŸ</th><th>å£²ä¸Š</th><th>çµŒè²»</th><th>åˆ©ç›Š</th></tr>`;
        history.forEach(h => {
            html += `<tr><td>${h.turn}</td><td>${h.sales.toLocaleString()}</td><td>${(h.laborCost + h.matCost + h.eventCost + h.happeningLoss).toLocaleString()}</td><td>${h.profit.toLocaleString()}</td></tr>`;
        });
        html += `</table>`;

        let comment = total > 500000 ? "ç«‹æ´¾ãªç¤¾é•·ã«ãªã‚Šã¾ã—ãŸï¼ä»Šã®ç¤¾é•·ã‚‚å¤§å–œã³ã§ã™ï¼" : "ã¾ã ã¾ã ä¿®è¡Œä¸­ã€‚ã§ã‚‚å¿ƒã¯ä¼ã‚ã‚Šã¾ã—ãŸï¼";
        html += `<p><b>${comment}</b></p>`;
        
        const mailBody = encodeURIComponent(`${teamName}ã®çµæœ\nåˆè¨ˆåˆ©ç›Š: ${total}å††`);
        html += `<button onclick="window.location.href='mailto:SAD22@gmail.com?subject=è·äººç´€è¡Œçµæœ&body=${mailBody}'">çµæœã‚’ãƒ¡ãƒ¼ãƒ«ã™ã‚‹</button>`;
        html += `<button onclick="location.reload()" style="background:#95a5a6;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>`;
        
        document.getElementById('content').innerHTML = html;
    }
</script>

</body>
</html>
