<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #f4f7f6;
            padding: 15px;
            color: #333;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 550px;
            margin: auto;
        }

        /* å¤§ããæŠ¼ã—ã‚„ã™ã„å…¥åŠ›ãƒ»é¸æŠã‚¨ãƒªã‚¢ */
        input[type="text"],
        select {
            font-size: 20px;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            width: 90%;
            border: 2px solid #3498db;
            background-color: #fff;
            cursor: pointer;
            box-sizing: border-box;
            display: inline-block;
        }

        p {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 5px 0;
        }

        button {
            font-size: 18px;
            margin: 20px 8px 8px 8px;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: #3498db;
            color: white;
            width: 85%;
            font-weight: bold;
        }

        button:active {
            background: #2980b9;
            transform: scale(0.98);
        }

        /* åæ”¯è¨ˆç®—è¡¨ã®èª¿æ•´ */
        .money-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }

        .money-table th,
        .money-table td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: center;
        }

        .money-table th {
            background-color: #ecf0f1;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .profit {
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="game-container">
        <h1 id="game-title">ğŸ”¨ ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</h1>
        <div id="content">
            <p>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
            <input type="text" id="team-name" placeholder="ãƒãƒ¼ãƒ å"><br>
            <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
    </div>

    <script>
        // â˜…GASã®URLã‚’æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw59a7aJTs7FNMk0nXEtSIbG_-sQLfcFFkRrrmv_DJRdZaUODak9MbnkC_57TS-zzrA/exec";

        let teamName = "";
        let turn = 1;
        let history = [];
        let prevMaterialWasCheap = false;

        const stages = [
            { name: "1æœŸï¼šçµŒå–¶è€…è¦‹ç¿’ã„ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ ", basePrice: 100000 },
            { name: "2æœŸï¼šæˆé•·ã¨æŒ‘æˆ¦ã®æ™‚æœŸ ğŸ¡", basePrice: 300000 },
            { name: "3æœŸï¼šç¤¾é•·ã¸ã®æ©è¿”ã— ğŸ°", basePrice: 600000 }
        ];

        function playSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const osc = context.createOscillator();
                const gain = context.createGain();
                osc.connect(gain); gain.connect(context.destination);
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, context.currentTime);
                gain.gain.setValueAtTime(0.1, context.currentTime);
                osc.start(); osc.stop(context.currentTime + 0.1);
            } catch (e) { console.log("Sound error"); }
        }

        function startGame() {
            teamName = document.getElementById('team-name').value || "è¦‹ç¿’ã„è·äºº";
            document.getElementById('game-title').innerText = "ğŸ”¨ " + teamName + "ã®è·äººç´€è¡Œ";
            playSound();
            showSelection();
        }

        function showSelection() {
            let stage = stages[turn - 1];
            let html = `<h3>${stage.name}</h3>`;

            html += `<p>ğŸ‘· é›‡ã†äººæ•°ã‚’é¸ã‚“ã§ã­</p>`;
            html += `<select id="workers">
                <option value="1">1å</option>
                <option value="2">2å</option>
                <option value="3">3å</option>
                <option value="4">4å</option>
            </select>`;

            html += `<p>ğŸ’° è·äººã®çµ¦æ–™è¨­å®š</p>`;
            html += `<select id="salary">
                <option value="5000">å®‰ã„ (5,000å††)</option>
                <option value="15000" selected>ãµã¤ã† (15,000å††)</option>
                <option value="30000">é«˜ç´š (30,000å††)</option>
            </select>`;

            html += `<p>ğŸ§± ä½¿ã†ææ–™ã®è³ª</p>`;
            html += `<select id="material">
                <option value="0.5">å®‰ã„ææ–™ (ãƒªã‚¹ã‚¯ã‚ã‚Šâš ï¸)</option>
                <option value="1.0" selected>æ¨™æº–ã®ææ–™</option>
                <option value="1.5">é«˜ç´šãªææ–™âœ¨</option>
            </select>`;

            if (turn === 2) {
                html += `<p style="color:#e67e22;">âœ¨ å¤§äº‹ãªã‚¤ãƒ™ãƒ³ãƒˆ (é¸ã‚“ã§ã­)</p>`;
                html += `<select id="event">
                    <option value="wedding">çµå©š (ç¥é‡‘ -5ä¸‡)</option>
                    <option value="indep">ç‹¬ç«‹æº–å‚™ (è²»ç”¨ -10ä¸‡)</option>
                    <option value="study">å­¦ã³ç›´ã— (è²»ç”¨ -3ä¸‡ / å£²ä¸ŠUP)</option>
                </select>`;
            }

            html += `<br><button onclick="calculateTurn()">æ±ºç®—ï¼æ¬¡ã®æœŸã¸</button>`;
            document.getElementById('content').innerHTML = html;
        }

        function calculateTurn() {
            playSound();
            let stage = stages[turn - 1];
            let workers = parseInt(document.getElementById('workers').value);
            let salary = parseInt(document.getElementById('salary').value);
            let mat = parseFloat(document.getElementById('material').value);

            let sales = stage.basePrice * mat;
            let happeningLoss = 0;
            let happeningName = "-";

            if (turn === 3) {
                if (prevMaterialWasCheap) {
                    happeningName = "æ¬ é™¥ã®è³ å„Ÿ";
                    happeningLoss = 200000;
                } else if (Math.random() < 0.4) {
                    happeningName = "äº‹æ•…ãƒ»ç—…æ°—";
                    happeningLoss = 100000;
                }
            }

            let eventCost = 0;
            let eventName = "-";
            if (turn === 2) {
                let ev = document.getElementById('event').value;
                if (ev === "wedding") { eventName = "çµå©š"; eventCost = 50000; }
                if (ev === "indep") { eventName = "ç‹¬ç«‹"; eventCost = 100000; }
                if (ev === "study") { eventName = "å­¦ã³"; eventCost = 30000; sales += 100000; }
            }

            let laborCost = workers * salary;
            let matCost = stage.basePrice * 0.4 * mat;
            let totalCost = laborCost + matCost + eventCost + happeningLoss;
            let profit = sales - totalCost;

            if (turn === 1 && mat < 1.0) prevMaterialWasCheap = true;

            history.push({
                turn,
                sales,
                laborCost,
                matCost,
                eventName,
                eventCost,
                happeningName,
                happeningLoss,
                profit
            });

            if (turn < 3) {
                turn++;
                showSelection();
            } else {
                showFinalResult();
            }
        }

        function showFinalResult() {
            let total = history.reduce((sum, h) => sum + h.profit, 0);
            let html = `<h2>æœ€çµ‚åæ”¯å ±å‘Šæ›¸</h2>`;

            html += `<table class="money-table">
                <thead>
                    <tr>
                        <th>æœŸ</th>
                        <th>å£²ä¸Š</th>
                        <th>çµ¦æ–™</th>
                        <th>ææ–™</th>
                        <th>ã‚¤ãƒ™ãƒ³ãƒˆ</th>
                        <th>ãƒãƒ—ãƒ‹ãƒ³ã‚°</th>
                        <th>åˆ©ç›Š</th>
                    </tr>
                </thead>
                <tbody>`;

            history.forEach(h => {
                html += `<tr>
                    <td>${h.turn}</td>
                    <td>${h.sales.toLocaleString()}</td>
                    <td>${h.laborCost.toLocaleString()}</td>
                    <td>${h.matCost.toLocaleString()}</td>
                    <td>${h.eventName}<br>(${(h.eventCost > 0 ? "-" : "") + h.eventCost.toLocaleString()})</td>
                    <td class="loss">${h.happeningName}<br>${h.happeningLoss > 0 ? "-" + h.happeningLoss.toLocaleString() : "0"}</td>
                    <td class="${h.profit >= 0 ? 'profit' : 'loss'}">${h.profit.toLocaleString()}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            html += `<h3 style="margin-top:20px;">åˆè¨ˆåˆ©ç›Š: <span class="profit">${total.toLocaleString()}å††</span></h3>`;

            let comment = total > 300000 ? "ç´ æ™´ã‚‰ã—ã„ï¼ä»Šã®ç¤¾é•·ã«æœ€é«˜ã®æ©è¿”ã—ãŒã§ãã¾ã—ãŸã­âœ¨" : "ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼æ¬¡ã¯ã‚‚ã£ã¨å¤§ããªæ©è¿”ã—ã‚’ç›®æŒ‡ãã†ï¼";
            html += `<p>${comment}</p>`;

            html += `<button onclick="saveAndRestart(${total})">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦<br>ã‚‚ã†ä¸€åº¦éŠã¶</button>`;
            document.getElementById('content').innerHTML = html;
        }

        async function saveAndRestart(total) {
            document.getElementById('content').innerHTML = "<h3>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ä¸­... ğŸš€</h3>";

            const payload = {
                teamName: teamName,
                history: history,
                total: total
            };

            try {
                // é€ä¿¡å‡¦ç†ï¼ˆno-corsãƒ¢ãƒ¼ãƒ‰ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç„¡è¦–ã—ã¦é€ä¿¡ã®ã¿å®Œé‚ã•ã›ã‚‹ï¼‰
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    cache: "no-cache",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            } catch (e) {
                console.error(e);
                alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
            }
            location.reload();
        }
    </script>

</body>

</html>