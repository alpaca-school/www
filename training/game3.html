<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #f4f7f6;
            padding: 15px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: auto;
        }

        button {
            font-size: 18px;
            margin: 8px;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: #3498db;
            color: white;
            width: 85%;
        }

        .money-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .money-table th,
        .money-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: right;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .profit {
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="game-container">
        <h1 id="game-title">ğŸ”¨ ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</h1>
        <div id="content">
            <p>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
            <input type="text" id="team-name" style="font-size: 18px; padding: 10px; width: 70%;"><br><br>
            <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxofuJnWD-8Zv_7f5QGxSldXP-b4pWjLXvyRavXb9fK__x6BUe_YBd2Dq8L5Re6xJXT/exec";
        let teamName = "";
        let turn = 1;
        let history = [];
        let prevMaterialWasCheap = false;

        const stages = [
            { name: "1æœŸï¼šè¦‹ç¿’ã„ ğŸ ", basePrice: 100000 },
            { name: "2æœŸï¼šæˆé•· ğŸ¡", basePrice: 300000 },
            { name: "3æœŸï¼šç¤¾é•·ã¸ã®æ©è¿”ã— ğŸ°", basePrice: 600000 }
        ];

        function playSound() {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            osc.connect(gain); gain.connect(context.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(1000, context.currentTime);
            gain.gain.setValueAtTime(0.1, context.currentTime);
            osc.start(); osc.stop(context.currentTime + 0.1);
        }

        function startGame() {
            teamName = document.getElementById('team-name').value || "è¦‹ç¿’ã„è·äºº";
            document.getElementById('game-title').innerText = "ğŸ”¨ " + teamName + "ã®è·äººç´€è¡Œ";
            playSound();
            showSelection();
        }

        function showSelection() {
            let stage = stages[turn - 1];
            let html = `<h3>${stage.name}</h3>`;
            html += `<p>äººæ•°: <select id="workers"><option value="1">1å</option><option value="2">2å</option><option value="3">3å</option><option value="4">4å</option></select></p>`;
            html += `<p>çµ¦æ–™: <select id="salary"><option value="5000">å®‰ã„</option><option value="15000" selected>ãµã¤ã†</option><option value="30000">é«˜ç´š</option></select></p>`;
            html += `<p>ææ–™: <select id="material"><option value="0.5">å®‰ã„(ãƒªã‚¹ã‚¯æœ‰)</option><option value="1.0" selected>æ¨™æº–</option><option value="1.5">é«˜ç´š</option></select></p>`;

            if (turn === 2) {
                html += `<p style="color:red; font-weight:bold;">âœ¨ ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„(å¿…é ˆ):</p>`;
                html += `<select id="event">
                <option value="wedding">çµå©š (ç¥é‡‘ -5ä¸‡)</option>
                <option value="indep">ç‹¬ç«‹æº–å‚™ (è²»ç”¨ -10ä¸‡)</option>
                <option value="study">å­¦ã³ç›´ã— (è²»ç”¨ -3ä¸‡ / å£²ä¸ŠUP)</option>
            </select>`;
            }
            html += `<br><button onclick="calculateTurn()">æ±ºç®—ï¼</button>`;
            document.getElementById('content').innerHTML = html;
        }

        function calculateTurn() {
            playSound();
            let stage = stages[turn - 1];
            let workers = parseInt(document.getElementById('workers').value);
            let salary = parseInt(document.getElementById('salary').value);
            let mat = parseFloat(document.getElementById('material').value);

            let sales = stage.basePrice * mat;
            let happeningLoss = 0;
            let happeningName = "-";

            if (turn === 3) {
                if (prevMaterialWasCheap) {
                    happeningName = "æ¬ é™¥ã®æå®³è³ å„Ÿ";
                    happeningLoss = 200000;
                } else if (Math.random() < 0.4) {
                    happeningName = "äº‹æ•…ãƒ»ç—…æ°—";
                    happeningLoss = 100000;
                }
            }

            let eventCost = 0;
            let eventName = "-";
            if (turn === 2) {
                let ev = document.getElementById('event').value;
                if (ev === "wedding") { eventName = "çµå©š"; eventCost = 50000; }
                if (ev === "indep") { eventName = "ç‹¬ç«‹"; eventCost = 100000; }
                if (ev === "study") { eventName = "å­¦ã³"; eventCost = 30000; sales += 70000; }
            }

            let laborCost = workers * salary;
            let matCost = stage.basePrice * 0.4 * mat;
            let totalCost = laborCost + matCost + eventCost + happeningLoss;
            let profit = sales - totalCost;

            if (turn === 1 && mat < 1.0) prevMaterialWasCheap = true;

            history.push({ turn, sales, laborCost, matCost, eventName, eventCost, happeningName, happeningLoss, profit });
            nextStep();
        }

        function nextStep() {
            if (turn < 3) { turn++; showSelection(); }
            else { showFinalResult(); }
        }

        function showFinalResult() {
            let total = history.reduce((sum, h) => sum + h.profit, 0);
            let html = `<h2>æœ€çµ‚åæ”¯å ±å‘Šæ›¸</h2>`;
            html += `<table class="money-table">
            <tr><th>æœŸ</th><th>å£²ä¸Š</th><th>çµ¦æ–™</th><th>ææ–™</th><th>ã‚¤ãƒ™ãƒ³ãƒˆ</th><th>ãƒãƒ—ãƒ‹ãƒ³ã‚°</th><th>åˆ©ç›Š</th></tr>`;

            history.forEach(h => {
                html += `<tr>
                <td>${h.turn}</td>
                <td>${h.sales.toLocaleString()}</td>
                <td>${h.laborCost.toLocaleString()}</td>
                <td>${h.matCost.toLocaleString()}</td>
                <td>${h.eventName}(${h.eventCost})</td>
                <td class="loss">${h.happeningName}<br>${h.happeningLoss.toLocaleString()}</td>
                <td class="profit">${h.profit.toLocaleString()}</td>
            </tr>`;
            });
            html += `</table>`;
            html += `<h3>åˆè¨ˆåˆ©ç›Š: ${total.toLocaleString()}å††</h3>`;
            html += `<button onclick="saveAndRestart(${total})">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦ã‚‚ã†ä¸€åº¦éŠã¶</button>`;
            document.getElementById('content').innerHTML = html;
        }

        async function saveAndRestart(total) {
            if (GAS_URL.includes("ã“ã“ã«")) {
                alert("GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼");
                location.reload();
                return;
            }

            // ä¿å­˜ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            document.getElementById('content').innerHTML = "<p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ä¸­...</p>";

            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ teamName, history, total })
                });
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
            } catch (e) {
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
            }
            location.reload();
        }
    </script>

</body>

</html>