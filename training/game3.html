<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #f4f7f6;
            padding: 15px;
            color: #333;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 550px;
            margin: auto;
        }

        /* å¤§ããæŠ¼ã—ã‚„ã™ã„å…¥åŠ›ãƒ»é¸æŠã‚¨ãƒªã‚¢ */
        input[type="text"],
        select {
            font-size: 20px;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            width: 90%;
            border: 2px solid #3498db;
            background-color: #fff;
            cursor: pointer;
            box-sizing: border-box;
            display: inline-block;
        }

        p {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 5px 0;
        }

        button {
            font-size: 18px;
            margin: 20px 8px 8px 8px;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: #3498db;
            color: white;
            width: 85%;
            font-weight: bold;
        }

        button:active {
            background: #2980b9;
            transform: scale(0.98);
        }

        /* åæ”¯è¨ˆç®—è¡¨ã®èª¿æ•´ */
        .money-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }

        .money-table th,
        .money-table td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: center;
        }

        .money-table th {
            background-color: #ecf0f1;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .profit {
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="game-container">
        <h1 id="game-title">ğŸ”¨ ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</h1>
        <div id="content">
            <p>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
            <input type="text" id="team-name" placeholder="ãƒãƒ¼ãƒ å"><br>
            <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw59a7aJTs7FNMk0nXEtSIbG_-sQLfcFFkRrrmv_DJRdZaUODak9MbnkC_57TS-zzrA/exec"; // â˜…å¿…ãšæ›´æ–°ã—ã¦ãã ã•ã„
        let teamName = "";
        let turn = 1;
        let history = [];
        let prevMaterialWasCheap = false;

        const stages = [
            { name: "1æœŸï¼šçµŒå–¶è€…è¦‹ç¿’ã„ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ ", basePrice: 100000 },
            { name: "2æœŸï¼šæˆé•·ã¨æŒ‘æˆ¦ã®æ™‚æœŸ ğŸ¡", basePrice: 300000 },
            { name: "3æœŸï¼šç¤¾é•·ã¸ã®æ©è¿”ã— ğŸ°", basePrice: 600000 }
        ];

        function startGame() {
            teamName = document.getElementById('team-name').value || "è¦‹ç¿’ã„è·äºº";
            document.getElementById('game-title').innerText = "ğŸ”¨ " + teamName + "ã®è·äººç´€è¡Œ";
            showSelection();
        }

        function showSelection() {
            let stage = stages[turn - 1];
            let html = `<h3>${stage.name}</h3>`;
            html += `<p>ğŸ‘· äººæ•°</p><select id="workers"><option value="1">1å</option><option value="2">2å</option><option value="3">3å</option><option value="4">4å</option></select>`;
            html += `<p>ğŸ’° çµ¦æ–™</p><select id="salary"><option value="5000">å®‰ã„</option><option value="15000" selected>ãµã¤ã†</option><option value="30000">é«˜ç´š</option></select>`;
            html += `<p>ğŸ§± ææ–™</p><select id="material"><option value="0.5">å®‰ã„(ãƒªã‚¹ã‚¯æœ‰)</option><option value="1.0" selected>æ¨™æº–</option><option value="1.5">é«˜ç´š</option></select>`;

            if (turn === 2) {
                html += `<p>âœ¨ ã‚¤ãƒ™ãƒ³ãƒˆ</p><select id="event"><option value="wedding">çµå©š</option><option value="indep">ç‹¬ç«‹</option><option value="study">å­¦ã³ç›´ã—</option></select>`;
            }

            // 3æœŸç›®ãªã‚‰ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚’ã€Œæ±ºç®—ï¼é€ä¿¡ã€ã«ã™ã‚‹
            const btnText = (turn === 3) ? "æ±ºç®—ï¼ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡" : "æ±ºç®—ï¼æ¬¡ã®æœŸã¸";
            html += `<br><button onclick="calculateTurn()">${btnText}</button>`;
            document.getElementById('content').innerHTML = html;
        }

        async function calculateTurn() {
            let stage = stages[turn - 1];
            let workers = parseInt(document.getElementById('workers').value);
            let salary = parseInt(document.getElementById('salary').value);
            let mat = parseFloat(document.getElementById('material').value);

            let sales = stage.basePrice * mat;
            let happeningLoss = 0; let happeningName = "-";
            if (turn === 3) {
                if (prevMaterialWasCheap) { happeningName = "æ¬ é™¥è³ å„Ÿ"; happeningLoss = 200000; }
                else if (Math.random() < 0.4) { happeningName = "äº‹æ•…ãƒ»ç—…æ°—"; happeningLoss = 100000; }
            }

            let eventCost = 0; let eventName = "-";
            if (turn === 2) {
                let ev = document.getElementById('event').value;
                if (ev === "wedding") { eventName = "çµå©š"; eventCost = 50000; }
                if (ev === "indep") { eventName = "ç‹¬ç«‹"; eventCost = 100000; }
                if (ev === "study") { eventName = "å­¦ã³"; eventCost = 30000; sales += 100000; }
            }

            let totalCost = (workers * salary) + (stage.basePrice * 0.4 * mat) + eventCost + happeningLoss;
            let profit = sales - totalCost;
            if (turn === 1 && mat < 1.0) prevMaterialWasCheap = true;

            history.push({ turn, workers, salary, mat, sales, eventName, eventCost, happeningName, happeningLoss, profit });

            if (turn < 3) {
                turn++;
                showSelection();
            } else {
                // 3æœŸç›®ã®æ±ºç®—ã‚’æŠ¼ã—ãŸç¬é–“ã«é€ä¿¡
                await saveDataToSheets();
                showFinalResult();
            }
        }

        async function saveDataToSheets() {
            const total = history.reduce((sum, h) => sum + h.profit, 0);
            document.getElementById('content').innerHTML = "<h3>ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­... ğŸš€</h3>";
            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify({ teamName, history, total })
                });
                console.log("é€ä¿¡å®Œäº†");
            } catch (e) { console.error(e); }
        }

        function showFinalResult() {
            let total = history.reduce((sum, h) => sum + h.profit, 0);
            let html = `<h2>æœ€çµ‚å ±å‘Šæ›¸</h2><table class="money-table">...ä¸­ç•¥...</table>`;
            // ï¼ˆåæ”¯è¡¨ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯å‰å›ã¨åŒã˜ï¼‰
            html += `<button onclick="location.reload()">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>`;
            document.getElementById('content').innerHTML = html; // å®Ÿéš›ã«ã¯ã“ã“ã«åæ”¯è¡¨ã®htmlã‚’çµ„ã¿ç«‹ã¦ã¦å…¥ã‚Œã¦ãã ã•ã„
        }
    </script>

</body>

</html>