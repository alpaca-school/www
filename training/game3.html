<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            text-align: center;
            background-color: #f4f7f6;
            padding: 15px;
            color: #333;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }

        /* å…¥åŠ›ãƒ»é¸æŠã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        input[type="text"],
        select {
            font-size: 20px;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            width: 90%;
            border: 2px solid #3498db;
            background-color: #fff;
            box-sizing: border-box;
        }

        p {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 5px 0;
        }

        button {
            font-size: 18px;
            margin: 20px 8px 8px 8px;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: #3498db;
            color: white;
            width: 85%;
            font-weight: bold;
            transition: 0.2s;
        }

        button:active {
            background: #2980b9;
            transform: scale(0.98);
        }

        /* æœ€çµ‚å ±å‘Šæ›¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .money-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }

        .money-table th,
        .money-table td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: center;
        }

        .money-table th {
            background-color: #ecf0f1;
        }

        .choice-summary {
            font-size: 10px;
            color: #666;
            display: block;
            margin-top: 5px;
            line-height: 1.2;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .profit {
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="game-container">
        <h1 id="game-title">ğŸ”¨ ãƒ¨ãƒŸã‚¿ãƒ³è·äººç´€è¡Œ</h1>
        <div id="content">
            <p>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
            <input type="text" id="team-name" placeholder="ãƒãƒ¼ãƒ åã‚’å…¥åŠ›"><br>
            <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
    </div>

    <script>
        // â˜…GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw59a7aJTs7FNMk0nXEtSIbG_-sQLfcFFkRrrmv_DJRdZaUODak9MbnkC_57TS-zzrA/exec";

        let teamName = "";
        let turn = 1;
        let history = [];
        let prevMaterialWasCheap = false;

        const stages = [
            { name: "1æœŸï¼šçµŒå–¶è€…è¦‹ç¿’ã„ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ ", basePrice: 100000 },
            { name: "2æœŸï¼šæˆé•·ã¨æŒ‘æˆ¦ã®æ™‚æœŸ ğŸ¡", basePrice: 300000 },
            { name: "3æœŸï¼šç¤¾é•·ã¸ã®æ©è¿”ã— ğŸ°", basePrice: 600000 }
        ];

        function playSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const osc = context.createOscillator();
                const gain = context.createGain();
                osc.connect(gain); gain.connect(context.destination);
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, context.currentTime);
                gain.gain.setValueAtTime(0.1, context.currentTime);
                osc.start(); osc.stop(context.currentTime + 0.1);
            } catch (e) { console.log("Sound error"); }
        }

        function startGame() {
            teamName = document.getElementById('team-name').value || "è¦‹ç¿’ã„è·äºº";
            document.getElementById('game-title').innerText = "ğŸ”¨ " + teamName + "ã®è·äººç´€è¡Œ";
            playSound();
            showSelection();
        }

        function showSelection() {
            let stage = stages[turn - 1];
            let html = `<h3>${stage.name}</h3>`;

            html += `<p>ğŸ‘· é›‡ã†äººæ•°</p>`;
            html += `<select id="workers">
                <option value="1">1å</option><option value="2">2å</option>
                <option value="3">3å</option><option value="4">4å</option>
            </select>`;

            html += `<p>ğŸ’° è·äººã®çµ¦æ–™</p>`;
            html += `<select id="salary">
                <option value="5000">å®‰ã„</option>
                <option value="15000" selected>ãµã¤ã†</option>
                <option value="30000">é«˜ç´š</option>
            </select>`;

            html += `<p>ğŸ§± ææ–™ã®è³ª</p>`;
            html += `<select id="material">
                <option value="0.5">å®‰ã„ææ–™ (ãƒªã‚¹ã‚¯âš ï¸)</option>
                <option value="1.0" selected>æ¨™æº–ã®ææ–™</option>
                <option value="1.5">é«˜ç´šãªææ–™âœ¨</option>
            </select>`;

            if (turn === 2) {
                html += `<p style="color:#e67e22;">âœ¨ å¤§äº‹ãªã‚¤ãƒ™ãƒ³ãƒˆ</p>`;
                html += `<select id="event">
                    <option value="wedding">çµå©š (ç¥é‡‘ -5ä¸‡)</option>
                    <option value="indep">ç‹¬ç«‹æº–å‚™ (è²»ç”¨ -10ä¸‡)</option>
                    <option value="study" selected>å­¦ã³ç›´ã— (è²»ç”¨ -3ä¸‡ / å£²ä¸ŠUP)</option>
                </select>`;
            }

            const btnText = (turn === 3) ? "æ±ºç®—ï¼ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦çµ‚äº†" : "æ±ºç®—ï¼æ¬¡ã®æœŸã¸";
            html += `<br><button onclick="calculateTurn()">${btnText}</button>`;
            document.getElementById('content').innerHTML = html;
        }

        async function calculateTurn() {
            playSound();
            let stage = stages[turn - 1];
            let workers = parseInt(document.getElementById('workers').value);
            let salary = parseInt(document.getElementById('salary').value);
            let mat = parseFloat(document.getElementById('material').value);

            let sales = stage.basePrice * mat;
            let happeningLoss = 0;
            let happeningName = "-";

            // 3æœŸç›®ã®ãƒãƒ—ãƒ‹ãƒ³ã‚°
            if (turn === 3) {
                if (prevMaterialWasCheap) {
                    happeningName = "æ¬ é™¥ã®è³ å„Ÿ";
                    happeningLoss = 200000;
                } else if (Math.random() < 0.4) {
                    happeningName = "äº‹æ•…ãƒ»ç—…æ°—";
                    happeningLoss = 100000;
                }
            }

            // 2æœŸç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            let eventCost = 0;
            let eventName = "-";
            if (turn === 2) {
                let ev = document.getElementById('event').value;
                if (ev === "wedding") { eventName = "çµå©š"; eventCost = 50000; }
                if (ev === "indep") { eventName = "ç‹¬ç«‹"; eventCost = 100000; }
                if (ev === "study") { eventName = "å­¦ã³"; eventCost = 30000; sales += 100000; }
            }

            let laborCost = workers * salary;
            let matCost = stage.basePrice * 0.4 * mat;
            let totalCost = laborCost + matCost + eventCost + happeningLoss;
            let profit = sales - totalCost;

            if (turn === 1 && mat < 1.0) prevMaterialWasCheap = true;

            // é¸æŠå±¥æ­´ã‚’è©³ç´°ã«ä¿å­˜
            history.push({
                turn, workers, salary, mat, sales, laborCost, matCost, eventName, eventCost, happeningName, happeningLoss, profit
            });

            if (turn < 3) {
                turn++;
                showSelection();
            } else {
                // 3æœŸç›®ã®æ±ºç®—ã§é€ä¿¡é–‹å§‹
                await sendToGas();
                showFinalResult();
            }
        }

        async function sendToGas() {
            const originalContent = document.getElementById('content').innerHTML;
            document.getElementById('content').innerHTML = "<h3>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ä¸­... ğŸš€</h3>";
            const total = history.reduce((sum, h) => sum + h.profit, 0);
            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ teamName, history, total })
                });
            } catch (e) {
                console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        function showFinalResult() {
            let total = history.reduce((sum, h) => sum + h.profit, 0);
            let html = `<h2>ğŸ“Š æœ€çµ‚åæ”¯å ±å‘Šæ›¸</h2>`;
            html += `<table class="money-table">
                <thead>
                    <tr>
                        <th>æœŸ / é¸æŠå†…å®¹</th>
                        <th>å£²ä¸Š</th>
                        <th>çµŒè²»</th>
                        <th>ãƒãƒ—ãƒ‹ãƒ³ã‚°</th>
                        <th>åˆ©ç›Š</th>
                    </tr>
                </thead>
                <tbody>`;

            history.forEach(h => {
                const matText = h.mat === 0.5 ? "å®‰ã„æ" : (h.mat === 1.5 ? "é«˜ç´šæ" : "æ¨™æº–æ");
                const choiceText = `äººæ•°:${h.workers} / çµ¦:${h.salary / 1000}k / ${matText}`;
                const exp = h.laborCost + h.matCost + h.eventCost;

                html += `<tr>
                    <td>${h.turn}æœŸ<br><span class="choice-summary">${choiceText}${h.eventName !== '-' ? '<br>ã‚¤ãƒ™:' + h.eventName : ''}</span></td>
                    <td>${h.sales.toLocaleString()}å††</td>
                    <td>${exp.toLocaleString()}å††</td>
                    <td class="loss">${h.happeningName}<br>${h.happeningLoss > 0 ? "-" + h.happeningLoss.toLocaleString() : "0"}</td>
                    <td class="${h.profit >= 0 ? 'profit' : 'loss'}">${h.profit.toLocaleString()}å††</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            html += `<h3 style="margin-top:20px;">åˆè¨ˆåˆ©ç›Š: <span class="profit">${total.toLocaleString()}å††</span></h3>`;

            let comment = total > 300000 ? "å¤§æˆåŠŸï¼ç«‹æ´¾ãªç¤¾é•·ã«ãªã£ã¦æ©è¿”ã—ãŒã§ãã¾ã—ãŸâœ¨" : "ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼æ¬¡ã¯ã‚‚ã£ã¨å¤§ããªæ©è¿”ã—ã‚’ï¼";
            html += `<p>${comment}</p>`;
            html += `<button onclick="location.reload()">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>`;

            document.getElementById('content').innerHTML = html;
        }
    </script>

</body>

</html>